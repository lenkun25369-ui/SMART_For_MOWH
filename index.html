<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SMART on FHIR Dashboard</title>

  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin: 20px;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      max-height: 400px;
      overflow: auto;
    }
    h1, h2 {
      margin-top: 1.2em;
    }
  </style>

  <!-- âœ… å®˜æ–¹ SMART on FHIR client -->
  <script src="https://cdn.jsdelivr.net/npm/fhirclient@2.8.6/build/fhir-client.min.js"></script>
</head>

<body>

  <h1>SMART on FHIR Dashboard</h1>

  <h2>Current Patient</h2>
  <pre id="patient">Loading...</pre>

  <h2>Recent Observations</h2>
  <pre id="observations">Loading...</pre>

  <script>
    /**
     * âœ… æ­£ç¢º SMART App åˆå§‹åŒ–ï¼ˆEHR launch å°ˆç”¨ï¼‰
     * âŒ ä¸è¦ç”¨ client = new FHIR.client(...)
     * âœ… ä¸€å®šè¦ç”¨ FHIR.oauth2.ready()
     */
    FHIR.oauth2.ready()
      .then(function (client) {

        // âœ… æ–¹ä¾¿ä½ åœ¨ DevTools çœ‹
        window.client = client;

        console.log("âœ… SMART READY");
        console.log("FHIR server:", client.state.serverUrl);
        console.log("Patient id:", client.patient && client.patient.id);

        const patientBox = document.getElementById("patient");
        const obsBox = document.getElementById("observations");

        // ğŸš¨ Sandbox æ²’æœ‰å‚³ç—…äººæ™‚
        if (!client.patient || !client.patient.id) {
          patientBox.textContent = "Error: Patient is not available";
          obsBox.textContent = "";
          return;
        }

        // 1ï¸âƒ£ è®€å–ç—…äººè³‡æ–™
        client.patient.read().then(function (patient) {
          patientBox.textContent = JSON.stringify(patient, null, 2);
        });

        // 2ï¸âƒ£ æŸ¥è©¢è©²ç—…äººçš„ Observation
        return client.request(
          "Observation?subject=Patient/" + client.patient.id +
          "&_sort=-date&_count=10",
          { pageLimit: 1, flat: true }
        );

      })
      .then(function (observations) {

        if (!observations) return;

        document.getElementById("observations").textContent =
          JSON.stringify(observations, null, 2);

      })
      .catch(function (error) {

        console.error("âŒ SMART ERROR", error);

        document.getElementById("patient").textContent =
          "Error: " + (error.message || error);
      });
  </script>

</body>
</html>
